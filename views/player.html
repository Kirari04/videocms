<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.7/plyr.css" />
    <style>
      html,
      body,
      .container {
        height: 100vh;
        width: 100vw;
        padding: 0;
        margin: 0;
        background: #1a1927;
      }
      .plyr {
        height: 100%;
      }
      .plyr__controls {
        justify-content: flex-start;
      }
      .plyr__controls .plyr__progress__container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: calc(var(--plyr-control-spacing, 10px) * 0.7) !important;
      }
      .plyr__controls__item.plyr__time.plyr__time--current {
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <video
        controls
        crossorigin
        playsinline
        poster="https://bitdash-a.akamaihd.net/content/sintel/poster.png"
      ></video>
    </div>
    <script>
      let Qualitys = JSON.parse(decodeURI("{{.Qualitys}}"));
      if (Qualitys == null) Qualitys = [];
      let Subtitles = JSON.parse(decodeURI("{{.Subtitles}}"));
      if (Subtitles == null) Subtitles = [];
      let Audios = JSON.parse(decodeURI("{{.Audios}}"));
      if (Audios == null) Audios = [];
      const UUID = "{{.UUID}}";
      const PROJECTURL = "{{.PROJECTURL}}";
      const TITLE = "{{.Title}}";
    </script>
    <script src="https://cdn.plyr.io/3.7.7/plyr.js"></script>
    <script src="https://cdn.rawgit.com/video-dev/hls.js/18bb552/dist/hls.min.js"></script>
    <script src="https://unpkg.com/sweetalert2@11.7.3/dist/sweetalert2.all.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const source = `/videos/qualitys/${UUID}/${Audios[0].uuid}/stream/master.m3u8`;
        const video = document.querySelector("video");

        const defaultOptions = {
          keyboard: { focused: false, global: true },
          captions: { active: false, language: "auto", update: true },
          tracks: Subtitles.map((Subtitle, i) => {
            return {
              kind: "captions",
              label: Subtitle.name,
              srclang: Subtitle.lang,
              src: Subtitle.url,
            };
          }),
          controls: () => {
            let controls = [
              "progress", // The progress bar and scrubber for playback and buffering
              "play-large", // The large play button in the center
              "rewind", // Rewind by the seek time (default 10 seconds)
              "play", // Play/pause playback
              "fast-forward", // Fast forward by the seek time (default 10 seconds)
              "restart", // Restart playback
              "current-time", // The current time of playback
              "duration", // The full duration of the media
              "mute", // Toggle mute
              "volume", // Volume control
              "captions", // Toggle captions
              "settings", // Settings menu
              "pip", // Picture-in-picture (currently Safari only)
              "airplay", // Airplay (currently Safari only)
              "fullscreen",
            ];
            return controls;
          },
        };

        if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = source;
          var player = new Plyr(video, defaultOptions);
          window.player = player;
        } else if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(source);
          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            const availableQualities = hls.levels.map((l) => l.height);
            availableQualities.unshift(0); //prepend 0 to quality array

            // Add new qualities to option
            defaultOptions.quality = {
              default: 0, //Default - AUTO
              options: availableQualities,
              forced: true,
              onChange: (e) => updateQuality(e),
            };
            // Add Auto Label
            defaultOptions.i18n = {
              qualityLabel: {
                0: "Auto",
              },
            };

            hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
              var span = document.querySelector(
                ".plyr__menu__container [data-plyr='quality'][value='0'] span"
              );
              if (hls.autoLevelEnabled) {
                span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`;
              } else {
                span.innerHTML = `AUTO`;
              }
            });

            var player = new Plyr(video, defaultOptions);
            window.player = player;
          });

          hls.attachMedia(video);
          window.hls = hls;
        } else {
          // use fallback url / download url
          video.src = Qualitys[0].url;
          var player = new Plyr(video, defaultOptions);
          window.player = player;
        }

        function updateQuality(newQuality) {
          if (newQuality === 0) {
            window.hls.currentLevel = -1; //Enable AUTO quality if option.value = 0
          } else {
            window.hls.levels.forEach((level, levelIndex) => {
              if (level.height === newQuality) {
                console.log("Found quality match with " + newQuality);
                window.hls.currentLevel = levelIndex;
              }
            });
          }
        }

        // save position
        setInterval(() => {
          if (!window.player.paused) {
            localStorage.setItem(`POSITION-${UUID}`, window.player.currentTime);
          }
        }, 1000);

        const oldPosition = parseInt(localStorage.getItem(`POSITION-${UUID}`));
        if (oldPosition > 0) {
          Swal.fire({
            title: "Do you want to start where you left last time?",
            showDenyButton: true,
            confirmButtonText: "Yes",
            denyButtonText: "No",
          }).then((result) => {
            if (result.isConfirmed) {
              window.player.currentTime = oldPosition;
            }
          });
        }
      });
    </script>
  </body>
</html>
