<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.plyr.io">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.7/plyr.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html,
    body,
    .container {
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin: 0;
      background: #1a1927;
      position: relative;
      font-family: 'Ubuntu', sans-serif;
    }

    .plyr {
      height: 100%;
    }

    .subtitle_container {
      pointer-events: none;
      height: 100%;
      width: 100%;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 10;
    }

    .plyr__controls {
      justify-content: flex-start;
    }

    .plyr__controls .plyr__progress__container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: calc(var(--plyr-control-spacing, 10px) * 0.7) !important;
    }

    .plyr__controls__item.plyr__time.plyr__time--current {
      margin-left: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="subtitle_container">
      <div class="subs"></div>
    </div>
    <video controls crossorigin playsinline poster="https://bitdash-a.akamaihd.net/content/sintel/poster.png"></video>
  </div>
  <script>
    let Qualitys = JSON.parse(decodeURI("{{.Qualitys}}"));
    if (Qualitys == null) Qualitys = [];
    let Subtitles = JSON.parse(decodeURI("{{.Subtitles}}"));
    if (Subtitles == null) Subtitles = [];
    let Audios = JSON.parse(decodeURI("{{.Audios}}"));
    if (Audios == null) Audios = [];
    const UUID = "{{.UUID}}";
    const PROJECTURL = "{{.PROJECTURL}}";
    const TITLE = "{{.Title}}";
  </script>
  <script src="https://cdn.plyr.io/3.7.7/plyr.js"></script>
  <script src="https://cdn.rawgit.com/video-dev/hls.js/18bb552/dist/hls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/assjs/dist/ass.min.js"></script>
  <script>
    const source = `/videos/qualitys/${UUID}/${Audios.find((Audio) => Audio.type == "hls").uuid
      }/stream/master.m3u8`;
    const video = document.querySelector("video");

    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 10000,
      timerProgressBar: true,
      showCloseButton: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    })

    const ShortToast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 1000,
      timerProgressBar: true,
    })

    function PlayerInit(options) {
      var player = new Plyr(video, options);
      player.on("ready", (event) => {
        if (window.ass) {
          setTimeout(() => {
            window.ass.resize()
          }, 1000)
        }
      })
      player.on("enterfullscreen", (event) => {
        if (window.ass) {
          setTimeout(() => {
            window.ass.resize()
          }, 1000)
        }
      })
      player.on("exitfullscreen", (event) => {
        if (window.ass) {
          setTimeout(() => {
            window.ass.resize()
          }, 1000)
        }
      })
      window.player = player;
      if (Subtitles.length > 0) {
        SubtitleInit(0);
      }
      // save position
      setInterval(() => {
        if (!window.player.paused) {
          localStorage.setItem(`POSITION-${UUID}`, window.player.currentTime);
        }
      }, 1000);

      const oldPosition = parseInt(localStorage.getItem(`POSITION-${UUID}`));
      if (oldPosition > 0) {
        Swal.fire({
          title: "Do you want to start where you left last time?",
          showDenyButton: true,
          confirmButtonText: "Yes",
          denyButtonText: "No",
        }).then((result) => {
          if (result.isConfirmed) {
            window.player.currentTime = oldPosition;
          }
        });
      }
    }
    function SubtitleInit(index) {
      const ass = new ASS(atob(Subtitles[index].data), video, {
        resampling: "video_width",
        container: document.querySelector(".subs"),
      });
      ass.show();
      window.ass = ass;
    }

    window.addEventListener("resize", () => {
      if (window.ass) {
        window.ass.resize()
      }
    })

    document.addEventListener("DOMContentLoaded", () => {
      const defaultOptions = {
        seekTime: 5,
        fullscreen: {
          enabled: true,
          fallback: true,
          iosNative: false,
          container: ".container"
        },
        iconUrl: "/icons/svgs.svg",
        keyboard: { focused: false, global: true },
        controls: () => {
          let controls = [
            "progress", // The progress bar and scrubber for playback and buffering
            "play-large", // The large play button in the center
            "play", // Play/pause playback
            "rewind", // Rewind by the seek time (default 10 seconds)
            "fast-forward", // Fast forward by the seek time (default 10 seconds)
            "current-time", // The current time of playback
            "duration", // The full duration of the media
            "mute", // Toggle mute
            "volume", // Volume control
            "settings", // Settings menu
            "pip", // Picture-in-picture (currently Safari only)
            "airplay", // Airplay (currently Safari only)
            "fullscreen",
          ];
          return controls;
        },
      };

      if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = source;
        PlayerInit(defaultOptions);
      } else if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(source);
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
          const availableQualities = hls.levels.map((l) => l.height);
          availableQualities.unshift(0); //prepend 0 to quality array

          // Add new qualities to option
          defaultOptions.quality = {
            default: 0, //Default - AUTO
            options: availableQualities,
            forced: true,
            onChange: (e) => updateQuality(e),
          };
          // Add Auto Label
          defaultOptions.i18n = {
            qualityLabel: {
              0: "Auto",
            },
          };

          hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
            var span = document.querySelector(
              ".plyr__menu__container [data-plyr='quality'][value='0'] span"
            );
            if (hls.autoLevelEnabled) {
              span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`;
            } else {
              span.innerHTML = `AUTO`;
            }
          });
          PlayerInit(defaultOptions);
        });

        hls.attachMedia(video);
        window.hls = hls;
      } else {
        // use fallback url / download url
        if (Qualitys.length === 1) {
          video.src = Qualitys[0].url;
          PlayerInit(defaultOptions);
        } else {
          PlayerInit(defaultOptions);
          Toast.fire({
            icon: 'error',
            title: `Your Browser doesn't support Hls and currently there is no alternativ stream available.`
          })
        }
      }

      function updateQuality(newQuality) {
        if (newQuality === 0) {
          window.hls.currentLevel = -1; //Enable AUTO quality if option.value = 0
        } else {
          window.hls.levels.forEach((level, levelIndex) => {
            if (level.height === newQuality) {
              console.log("Found quality match with " + newQuality);
              window.hls.currentLevel = levelIndex;
            }
          });
        }
      }
    });
  </script>
</body>

</html>