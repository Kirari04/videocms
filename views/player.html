<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watch {{.Title}}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet" />
    <style>
        html,
        body {
            height: 100vh;
            width: 100vw;
            padding: 0;
            margin: 0;
            background-color: black;
            color: white;
            font-family: "Roboto", sans-serif;
        }

        #dplayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* #player iframe,
      #player object,
      #player embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      } */
    </style>
</head>

<body>
    <div id="dplayer"></div>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script src="https://unpkg.com/dplayer@1.27.1/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const Qualitys = JSON.parse(decodeURI("{{.Qualitys}}")).map((el) => {
            el.file = el.file.replace("./", "/");
            return el;
        });
        const Subtitles = JSON.parse(decodeURI("{{.Subtitles}}"));
        const EncQualitys = JSON.parse(decodeURI("{{.EncQualitys}}"));
        const UUID = "{{.UUID}}";
    </script>
    <template id="encoding-template">
        <swal-title id="popuptitle">
            This file is still encoding {{.ActiveEncodes}} more quality! <br />
            Thats why some qualitys may not be available yet. <br />
            Reload the page to check for new qualitys.
        </swal-title>
        <swal-button type="confirm"> Ok </swal-button>
        <swal-button type="deny" color="#545454"> Reload </swal-button>
        <swal-param name="allowEscapeKey" value="true" />
    </template>
    <script>
        function getM3u8String(file, width, height) {
            return `\n#EXT-X-STREAM-INF:BANDWIDTH=${parseInt(width) * parseInt(height) * 20
                },RESOLUTION=${width}x${height},CODECS="avc1.640015,mp4a.40.2"\n${window.location.origin
                }${file}\n`;
        }
        function getM3u8Stream(qualitys) {
            let m3u8 = `#EXTM3U\n#EXT-X-VERSION:6`;
            qualitys.forEach((quality) => {
                m3u8 += getM3u8String(quality.file, quality.width, quality.height);
            });

            const blob = new Blob([m3u8], {
                type: "text/plain",
            });
            let url = URL.createObjectURL(blob);
            return url;
        }

        let defaultQuality = 0;
        let index720p = Qualitys.findIndex((el) => el.label === "720p");
        if (index720p !== -1 && defaultQuality == 0) defaultQuality = index720p;
        let index480p = Qualitys.findIndex((el) => el.label === "480p");
        if (index480p !== -1 && defaultQuality == 0) defaultQuality = index480p;
        let index1080p = Qualitys.findIndex((el) => el.label === "1080p");
        if (index1080p !== -1 && defaultQuality == 0) defaultQuality = index1080p;

        let dpQualitys = Qualitys.map((Quality) => {
            return {
                name: Quality.label,
                url: Quality.file,
                type: "hls",
            };
        });
        dpQualitys.push({
            name: "Auto",
            url: getM3u8Stream(Qualitys),
            type: "hls",
        });
        const dp = new DPlayer({
            container: document.getElementById("dplayer"),
            screenshot: false,
            video: {
                defaultQuality: defaultQuality,
                quality: dpQualitys,
            },
            subtitle: {
                url: (!Subtitles)?[]:Subtitles,
                defaultSubtitle: Subtitles.length,
                type: 'webvtt',
                fontSize: '25px',
                bottom: '10%',
                color: '#b7daff'
            },

        });

        // custom buttons
        function addRightButton(className, label, img, callback) {
            const rightControls = document.querySelector(
                ".dplayer-icons.dplayer-icons-right"
            );
            const div = document.createElement("div");
            div.addEventListener("click", callback);
            div.classList.add("dplayer-icon");
            div.classList.add(className);
            div.style.position = "relative";
            div.style.height = "40px";
            div.style.padding = "0px";
            const button = document.createElement("button");
            button.classList.add("dplayer-icon");
            button.classList.add("dplayer-setting-icon");
            button.setAttribute("data-balloon", label);
            button.style.position = "relative";
            button.style.height = "100%";
            const span = document.createElement("span");
            span.style.position = "relative";
            span.style.height = "100%";
            span.style.color = "#fff";
            span.style.display = "inline-block";
            span.classList.add("dplayer-icon-content");
            span.innerHTML = `<img src="${img}" style="height: 100%;">`;

            button.appendChild(span);
            div.appendChild(button);
            rightControls.prepend(div);
        }

        addRightButton("dplayer-cool", "Forward 10 sec", "/plus.svg", () =>
            dp.seek(dp.video.currentTime + 10)
        );
        addRightButton("dplayer-cool", "Rewind 10 sec", "/minus.svg", () =>
            dp.seek(dp.video.currentTime - 10)
        );

        // save position
        setInterval(() => {
            localStorage.setItem(`POSITION-${UUID}`, dp.video.currentTime);
        }, 1000);

        const oldPosition = parseInt(localStorage.getItem(`POSITION-${UUID}`));
        if (oldPosition > 0) {
            Swal.fire({
                title: "Do you want to start where you left last time?",
                showDenyButton: true,
                confirmButtonText: "Yes",
                denyButtonText: "No",
            }).then((result) => {
                if (result.isConfirmed) {
                    dp.seek(oldPosition);
                }
            });
        }

        EncQualitys.forEach(EncQuality => {
            dp.notice(`The server is still encoding the quality ${EncQuality.label} (${Math.round(parseFloat(EncQuality.progress)*100)}%)`, 10000, 0.8);
        })
        
    </script>
</body>

</html>